#!/usr/bin/env python3

import os
import argparse
import sys
import logging
sys.path.append(os.path.join(os.path.dirname(os.path.realpath(__file__)), ".."))

from commons.constants import *
from commons.funcs_common import get_selection, get_cdcbench_version, get_except_msg, get_true_option
from commons.funcs_initial import InitialFunctions
from commons.mgr_config import ConfigManager
from commons.mgr_logger import LoggerManager

from sqlalchemy.exc import DatabaseError
from json import JSONDecodeError


def initializer():

    # Working Directory를 ~/cdcbench로 변경
    os.chdir(os.path.join(os.path.dirname(os.path.realpath(__file__)), ".."))

    # CLI argument parsing
    help_formatter = lambda prog: argparse.RawTextHelpFormatter(prog, max_help_position=6)

    parser = argparse.ArgumentParser(prog="initializer", usage="%(prog)s [option...][argument...]", allow_abbrev=False,
                                     formatter_class=help_formatter)

    exec_groups = parser.add_mutually_exclusive_group()
    dest_groups = parser.add_mutually_exclusive_group()

    exec_groups.add_argument("--create", action="store_true",
                             help="create the objects and initiate the data related to CDCBENCH")

    exec_groups.add_argument("--drop", action="store_true",
                             help="drop the objects related to CDCBENCH")

    exec_groups.add_argument("--reset", action="store_true",
                             help="reset the objects and data related to CDCBENCH")

    dest_groups.add_argument("--source", action="store_true",
                             help="specifies the initialization destination as the source of the configuration file")

    dest_groups.add_argument("--target", action="store_true",
                             help="specifies the initialization destination as the target of the configuration file")

    dest_groups.add_argument("--both", action="store_true",
                             help="specifies the initialization destination as the Source and Target of the configuration file")

    parser.add_argument("--config", action="store", nargs="?", metavar="config_file_name", const="default.ini",
                        help="view or select configuration file")

    parser.add_argument("-v", "--version", action="version", version=get_cdcbench_version(),
                        help="print CDCBENCH\'s Version.")

    args = parser.parse_args()

    # 아무 옵션도 없을 경우 예외처리
    if args.config is None and not args.create and not args.drop and not args.reset \
            and not args.source and not args.target and not args.both:
        parser.error("Invalid options or arguments")

    # --source, --target, --both 옵션만 사용할 경우 예외처리
    elif (args.source or args.target or args.both) and (not args.create and not args.drop and not args.reset):
        true_opt = get_true_option(args.__dict__)
        parser.error("--{} is required --create or --drop or --reset".format(true_opt))

    config = None
    logger = None
    sql_logger = None

    print()

    try:

        # config 옵션 존재 유무에 따라 Config 객체 생성 분리
        # config 옵션 존재
        if args.config:

            config = ConfigManager(args.config)
            logger = LoggerManager.get_logger(__name__, config.log_level)

            logger.info("Module initializer is started")

            # --config 옵션을 제외한 다른 옵션이 없을 경우 해당 Config 내용을 출력
            if not args.create and not args.drop and not args.reset \
                    and not args.source and not args.target and not args.both:
                config.view_config()
                logger.info("Load configuration file ({})".format(config.config_name))
                logger.info(config.get_config_dict())

                exit(1)

        # config 옵션 없음
        else:

            config = ConfigManager()
            logger = LoggerManager.get_logger(__name__, config.log_level)

            logger.info("Module initializer started")

        if config.sql_log_level != logging.WARNING:
            sql_logger = LoggerManager.get_sql_logger(config.sql_log_level)

        logger.info("Load configuration file ({})".format(config.config_name))
        logger.info(config.get_config_dict())

        select_warn_msg = "initializer: warning: invalid input value. please enter \"y\" or \"n\".\n"

        initial_functions = InitialFunctions()
        update_total_data, update_commit_unit, delete_total_data, delete_commit_unit = \
            config.get_init_data_info().values()

        # destination 옵션 처리
        if args.target:
            destination = TARGET
            print("\n" + config.view_target_connection_config() + "\n\n" +
                  config.view_init_data_config() + "\n")
        elif args.both:
            destination = BOTH
            print("\n" + config.view_both_connection_config() + "\n\n" +
                  config.view_init_data_config() + "\n")
        else:
            destination = SOURCE
            print("\n" + config.view_source_connection_config() + "\n\n" +
                  config.view_init_data_config() + "\n")

        # create option
        if args.create:

            print_msg = "Do you want to create CDCBENCH related objects and data from the above database? [y/N]: "

            while True:
                select = get_selection(print_msg)

                if select is True:
                    print()
                    initial_functions.create(destination)
                    initial_functions.initializing_data(destination, UPDATE_TEST, update_total_data, update_commit_unit)
                    initial_functions.initializing_data(destination, DELETE_TEST, delete_total_data, delete_commit_unit)
                    break
                elif select is False:
                    print("\ninitializer: warning: operation is canceled by user\n")
                    break
                else:
                    print(select_warn_msg)

        # drop option
        elif args.drop:

            print_msg = "Do you want to drop CDCBENCH related objects and data from the above database? [y/N]: "

            while True:
                select = get_selection(print_msg)

                if select is True:
                    print()
                    initial_functions.drop(destination)
                    break
                elif select is False:
                    print("\ninitializer: warning: operation is canceled by user\n")
                    break

                else:
                    print(select_warn_msg)

        # reset option
        elif args.reset:

            print_msg = "Do you want to reset CDCBENCH related objects and data from the above database? [y/N]: "

            while True:
                select = get_selection(print_msg)

                if select is True:
                    print()
                    initial_functions.drop(destination)
                    initial_functions.create(destination)
                    initial_functions.initializing_data(destination, UPDATE_TEST, update_total_data, update_commit_unit)
                    initial_functions.initializing_data(destination, DELETE_TEST, delete_total_data, delete_commit_unit)
                    break
                elif select is False:
                    print("\ninitializer: warning: operation is canceled by user")
                    break
                else:
                    print(select_warn_msg)

    except FileNotFoundError as ferr:
        get_except_msg(ferr)
        exit(1)

    except KeyError as kerr:
        get_except_msg("Configuration parameter does not existed: {}".format(kerr))
        exit(1)

    except DatabaseError as dberr:
        get_except_msg(dberr.args[0])
        exit(1)

    except JSONDecodeError as jerr:
        get_except_msg("Invalid JSON format of data file. line {} column {} (position {})"
                       .format(jerr.lineno, jerr.colno, jerr.pos))

    except ValueError as valerr:
        get_except_msg(valerr)
        exit(1)

    finally:
        if logger is not None:
            logger.info("Module initializer is ended\n")


if __name__ == "__main__":
    try:
        initializer()
    except KeyboardInterrupt as err:
        print("\n\ninitializer: warning: operation is canceled by user  ")
        exit(1)
